<!doctype html>
<html>

<head>
	<title>Line Chart</title>
	<script async src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
	<style>
		canvas {
			-moz-user-select: none;
			-webkit-user-select: none;
			-ms-user-select: none;
		}
	</style>
</head>

<body>
	<div>
		<button onclick="js()">JavaScript TSP</button>
		<button onclick="rs()">Rust + WASM TSP</button>
		<button onclick="location.reload()">New Tour</button>
	</div>
	<div style="width: 100%;">
		<canvas id="canvas"></canvas>
	</div>
	<div style="width: 100%;height: 100px;">
		<canvas id="fitness"></canvas>
	</div>
	<script>
		function getConfig(_tour) {
			let x = _tour.map((t) => t.x);
			let y = _tour.map((t) => t.y);
			return {
				type: 'line',
				data: {
					datasets: [{
						fill: false,
						borderColor: "#DC7633",
						data: _tour,
					}]
				},
				options: {
					legend: false,
					responsive: true,
					tooltips: {
						mode: 'nearest',
						intersect: false,
					},
					scales: {
						xAxes: [{
							type: 'linear',
							ticks: {
								min: Math.min(...x) - 2,
								max: Math.max(...x) + 2,
							}
						}],
						yAxes: [{
							type: 'linear',
							ticks: {
								min: Math.min(...y) - 2,
								max: Math.max(...y) + 2,
							}
						}],
					}
				}
			};
		}

		function historyConfig(history, color) {
			return {
				type: 'line',
				data: {
					labels: [...Array(400).keys()],
					datasets: [{
						fill: false,
						borderColor: color,
						pointRadius: 0,
						data: history,
					}]
				},
				options: {
					legend: false,
					responsive: true,
					gridlines: false,
					tooltips: {
						mode: 'nearest',
						intersect: false,
					},
					title: {
						display: true,
            			text: 'Fitness'
					},
					scales: {
						xAxes: [{
							gridLines: false,
							distribution: "series",
							scaleLabel: { display: true, labelString: "Generations" },
							ticks: {
								display: false
							}
						}],
						yAxes: [{
							type: 'linear',
							scaleLabel: { display: true, labelString: "Fitness" },
							ticks: {
								min: 0
							}
						}],
					}
				}
			};
		}

		function refreshChart(cities) {
			let chart = window.tsp;
			chart.data.datasets[0].data = cities;
			chart.update(0);
		}

		function plotHistory(history) {
			let chart = window.fitness;
			chart.data.datasets[0].data = history;
			chart.update();
		}

		function createTour(n) {
			return Array.from({
					length: n
				},
				(x, i) => ({
					x: Math.random() * 10,
					y: Math.random() * 10
				}));
		}

		async function solve(url, _tour) {
			let rq = new Request(url, {
				method: 'POST',
				body: `{ "tour": ${JSON.stringify(_tour)}}`
			});

			let tour = await fetch(rq)
				.then(data => (data.json()));
			return tour;
		}

		let tour = createTour(20);

		window.onload = () => {
			let tsp = document.getElementById('canvas').getContext('2d');
			window.tsp = new Chart(tsp, getConfig(tour));

			let hist = document.getElementById('fitness').getContext('2d');
			window.fitness = new Chart(hist, historyConfig([]));
		}

		function js() {
			solve("https://wasmga.azurewebsites.net/api/js", tour).then((solution) => {
				refreshChart(solution.tour);
				plotHistory(solution.history);
			});
		}

		function rs() {
			let solved = solve("https://wasmga.azurewebsites.net/api/rs", tour).then((solution) => {
				console.log(solution);
				refreshChart(solution.tour);
				plotHistory(solution.history);
			});
		}
	</script>
</body>

</html>